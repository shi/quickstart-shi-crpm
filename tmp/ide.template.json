{
  "Description": "Cloud9 IDE with crpm pre-installed and quick start code checked out",
  "Resources": {
    "EnvironmentEC2": {
      "Type": "AWS::Cloud9::EnvironmentEC2",
      "Properties": {
        "InstanceType": "t2.small",
        "Description": "Created by an AWS Quick Start.  CRPM is pre-installed and the infrastructure code master branch is checked out.",
        "Name": {
          "Ref": "AWS::StackName"
        },
        "Repositories": [
          {
            "PathComponent": "/quick-start",
            "RepositoryUrl": {
              "Fn::Join": [
                "",
                [
                  "https://git-codecommit.",
                  {
                    "Ref": "AWS::Region"
                  },
                  ".amazonaws.com/v1/repos/quick-start"
                ]
              ]
            }
          }
        ]
      },
      "Metadata": {
        "aws:cdk:path": "ide/EnvironmentEC2"
      }
    },
    "EC2Role": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": [
                  "ec2.amazonaws.com"
                ]
              },
              "Action": [
                "sts:AssumeRole"
              ]
            }
          ]
        },
        "Description": "This role is included in an instance profile that is associated with an EC2 instance so SSM commands can be run on it",
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore"
        ],
        "RoleName": {
          "Fn::Join": [
            "",
            [
              "ec2-",
              {
                "Ref": "AWS::StackName"
              }
            ]
          ]
        }
      },
      "Metadata": {
        "aws:cdk:path": "ide/EC2Role"
      }
    },
    "InstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Roles": [
          {
            "Ref": "EC2Role"
          }
        ],
        "InstanceProfileName": {
          "Ref": "AWS::StackName"
        }
      },
      "Metadata": {
        "aws:cdk:path": "ide/InstanceProfile"
      }
    },
    "Document": {
      "Type": "AWS::SSM::Document",
      "Properties": {
        "Content": {
          "schemaVersion": "2.2",
          "description": "Configure Cloud9 Amazon Linux EC2 instance",
          "mainSteps": [
            {
              "action": "aws:runShellScript",
              "name": "InstallCRPM",
              "inputs": {
                "runCommand": [
                  "runuser -l ec2-user -c 'npm uninstall -g cdk'",
                  "runuser -l ec2-user -c 'npm install -g aws-cdk@1.57.0 crpm@2.1.0 typescript'"
                ],
                "timeoutSeconds": 3600
              }
            }
          ]
        },
        "DocumentType": "Command",
        "Name": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "AWS::StackName"
              },
              "-configure-cloud9"
            ]
          ]
        }
      },
      "Metadata": {
        "aws:cdk:path": "ide/Document"
      }
    },
    "LambdaRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com"
              },
              "Action": [
                "sts:AssumeRole"
              ]
            }
          ]
        },
        "Policies": [
          {
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "ec2:AssociateIamInstanceProfile",
                    "ec2:DescribeInstances",
                    "ec2:RebootInstances",
                    "iam:PassRole",
                    "logs:CreateLogGroup",
                    "logs:CreateLogStream",
                    "logs:PutLogEvents",
                    "s3:DeleteObject",
                    "s3:DeleteObjectVersion",
                    "s3:ListBucketVersions",
                    "s3:PutObject",
                    "ssm:DescribeInstanceInformation",
                    "ssm:SendCommand"
                  ],
                  "Resource": "*"
                }
              ]
            },
            "PolicyName": "root"
          }
        ],
        "RoleName": {
          "Fn::Join": [
            "",
            [
              "lambda-",
              {
                "Ref": "AWS::StackName"
              }
            ]
          ]
        }
      },
      "Metadata": {
        "aws:cdk:path": "ide/LambdaRole"
      }
    },
    "Function": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "Code": {
          "ZipFile": "const aws = require('aws-sdk');\nconst response = require('cfn-response');\nconst util = require('util');\n\nconst ec2 = new aws.EC2({ apiVersion: '2016-11-15' });\nconst ssm = new aws.SSM({ apiVersion: '2014-11-06' });\nconst send = util.promisify(response.send);\n\nexports.handler =  async function(event, context) {\n  const cloud9EnvironmentId = event.ResourceProperties.cloud9EnvironmentId;\n  console.log(event.RequestType, 'Cloud9 Environment:', cloud9EnvironmentId);\n  \n  if (event.RequestType != 'Create') {\n    await send(event, context, response.SUCCESS);\n    return;\n  }\n  \n  try {\n    const instanceParams = {\n      Filters: [\n        {\n          Name: 'tag:aws:cloud9:environment',\n          Values: [\n            cloud9EnvironmentId\n          ]\n        }\n      ]\n    };\n    \n    // Get the instance ID\n    let data = await ec2.describeInstances(instanceParams).promise();\n    const instanceId = data.Reservations[0].Instances[0].InstanceId;\n    console.log('Instance ID:', instanceId);\n      \n    // Associate an instance profile for SSM\n    const instanceProfileName = event.ResourceProperties.instanceProfileName;\n    await ec2.associateIamInstanceProfile({\n      IamInstanceProfile: {\n        Name: instanceProfileName\n      },\n      InstanceId: instanceId\n    }).promise();\n    console.log('Associated instance profile', instanceProfileName);\n    \n    // Reboot the instance to make it available in SSM sooner\n    console.log('Rebooting Instance');\n    await ec2.rebootInstances({\n      InstanceIds: [\n        instanceId\n      ]\n    }).promise();\n    \n    // Wait for the instance to be running\n    await ec2.waitFor('instanceRunning', instanceParams).promise();\n    console.log('Instance Running');\n    \n    for (var i = 0; i < 16; i++) {\n      console.log('Waiting for SSM');\n      data = await ssm.describeInstanceInformation({\n        Filters: [\n          {\n            Key: 'InstanceIds',\n            Values: [\n              instanceId\n            ]\n          }\n        ]\n      }).promise();\n      if (data.InstanceInformationList.length > 0) {\n        console.log('Instance Ready');\n        break;\n      } else if (i == 15) {\n        await send(event, context, response.FAILED, { Error: 'Instance is not available in SSM' });\n      }\n      \n      // Sleep 15 seconds\n      await new Promise((resolve) => setTimeout(resolve, 15000));\n    }\n    \n    // Run a configuration script on the instance\n    const ssmDocumentName = event.ResourceProperties.ssmDocumentName;\n    data = await ssm.sendCommand({\n      DocumentName: ssmDocumentName,\n      CloudWatchOutputConfig: {\n        CloudWatchLogGroupName: `/aws/lambda/${context.functionName}`,\n        CloudWatchOutputEnabled: true\n      },\n      Comment: 'Configure Cloud9 Environment',\n      InstanceIds: [\n        instanceId\n      ]\n    }).promise();\n    console.log('Sent configuration script for execution via SSM', ssmDocumentName);\n  } catch (err) {\n    await send(event, context, response.FAILED, err);\n    return;\n  }\n  \n  await send(event, context, response.SUCCESS);\n};\n"
        },
        "Handler": "index.handler",
        "Role": {
          "Fn::GetAtt": [
            "LambdaRole",
            "Arn"
          ]
        },
        "Runtime": "nodejs10.x",
        "Description": "Configures a Cloud9 instance",
        "FunctionName": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "AWS::StackName"
              },
              "-custom-resource"
            ]
          ]
        },
        "Timeout": 300
      },
      "Metadata": {
        "aws:cdk:path": "ide/Function"
      }
    },
    "CustomResource": {
      "Type": "AWS::CloudFormation::CustomResource",
      "Properties": {
        "ServiceToken": {
          "Fn::GetAtt": [
            "Function",
            "Arn"
          ]
        },
        "cloud9EnvironmentId": {
          "Ref": "EnvironmentEC2"
        },
        "instanceProfileName": {
          "Ref": "InstanceProfile"
        },
        "ssmDocumentName": {
          "Ref": "Document"
        }
      },
      "Metadata": {
        "aws:cdk:path": "ide/CustomResource"
      }
    }
  }
}